import React, { useState, useRef, useEffect } from 'react';
import { Upload, Button, Modal, List, Pagination, message, Space } from 'antd'; // 假设用AntD，可替换为其他UI库
import { UploadOutlined, DeleteOutlined, EyeOutlined } from '@ant-design/icons';
import type { UploadFile, UploadProps } from 'antd/es/upload/interface';
import ImageCard from './ImageCard'; // 抽离的图片卡片组件
import ImageUploader from './ImageUploader'; // 抽离的上传组件
import ImagePreviewModal from './ImagePreviewModal'; // 抽离的预览弹窗组件

// 图片类型定义
interface ImageItem {
  id: string;
  url: string;
  name: string;
  size: number;
  uploadTime: string;
}

const ImageManager: React.FC = () => {
  // 状态管理
  const [imageList, setImageList] = useState<ImageItem[]>([]); // 图片列表
  const [previewVisible, setPreviewVisible] = useState(false); // 预览弹窗显隐
  const [previewImage, setPreviewImage] = useState(''); // 预览图片地址
  const [currentPage, setCurrentPage] = useState(1); // 当前分页
  const [pageSize] = useState(10); // 每页条数
  const fileInputRef = useRef<HTMLInputElement>(null);

  // 模拟从接口获取图片列表（替换为真实接口）
  useEffect(() => {
    // 真实场景替换为axios/fetch请求
    const mockData: ImageItem[] = [
      {
        id: '1',
        url: 'https://via.placeholder.com/200',
        name: '示例图片1.jpg',
        size: 204800,
        uploadTime: '2024-01-01 10:00',
      },
    ];
    setImageList(mockData);
  }, []);

  // 处理图片删除
  const handleDelete = (id: string) => {
    Modal.confirm({
      title: '确认删除',
      content: '是否确定删除该图片？删除后不可恢复',
      onOk: () => {
        setImageList(imageList.filter(item => item.id !== id));
        message.success('删除成功');
      },
    });
  };

  // 处理图片预览
  const handlePreview = (url: string) => {
    setPreviewImage(url);
    setPreviewVisible(true);
  };

  // 处理分页切换
  const handlePageChange = (page: number) => {
    setCurrentPage(page);
    // 真实场景：重新请求对应分页的图片列表
  };

  // 处理上传成功后的回调
  const handleUploadSuccess = (file: UploadFile) => {
    const newImage: ImageItem = {
      id: Date.now().toString(),
      url: file.url || '',
      name: file.name || '未命名图片',
      size: file.size || 0,
      uploadTime: new Date().toLocaleString(),
    };
    setImageList([...imageList, newImage]);
    message.success('上传成功');
  };

  // 分页后展示的列表
  const displayList = imageList.slice(
    (currentPage - 1) * pageSize,
    currentPage * pageSize
  );

  return (
    <div style={{ padding: '20px', maxWidth: '1200px', margin: '0 auto' }}>
      <h2>图片管理</h2>

      {/* 上传区域 - 抽离为独立组件 */}
      <ImageUploader 
        onUploadSuccess={handleUploadSuccess} 
        fileInputRef={fileInputRef}
      />

      {/* 图片列表区域 */}
      {displayList.length > 0 ? (
        <List
          grid={{ gutter: 16, column: 4, xs: 1, sm: 2, md: 3, lg: 4 }}
          dataSource={displayList}
          renderItem={(item) => (
            <ImageCard
              image={item}
              onPreview={() => handlePreview(item.url)}
              onDelete={() => handleDelete(item.id)}
            />
          )}
          style={{ marginTop: '20px' }}
        />
      ) : (
        <div style={{ textAlign: 'center', padding: '40px', color: '#999' }}>
          暂无图片，请上传
        </div>
      )}

      {/* 分页控件 */}
      {imageList.length > pageSize && (
        <div style={{ textAlign: 'right', marginTop: '20px' }}>
          <Pagination
            current={currentPage}
            pageSize={pageSize}
            total={imageList.length}
            onChange={handlePageChange}
            showSizeChanger={false}
          />
        </div>
      )}

      {/* 预览弹窗 - 抽离为独立组件 */}
      <ImagePreviewModal
        visible={previewVisible}
        imageUrl={previewImage}
        onClose={() => setPreviewVisible(false)}
      />
    </div>
  );
};

export default ImageManager;