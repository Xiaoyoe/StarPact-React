import React, { useState, useRef, useCallback, useEffect } from 'react';
import {
  getCharDiffs,
  generateUnifiedDiff,
  extractFromContent,
  getTimestamp,
  isValidSaveName,
  type CharDiff,
  type UnifiedDiffLine,
} from '../utils/diffEngine';

// ---- Storage helpers (localStorage-based persistence) ----
const STORAGE_PREFIX = 'text_compare_';
const AUTO_SAVE_KEY = STORAGE_PREFIX + 'auto_save';
const SAVES_INDEX_KEY = STORAGE_PREFIX + 'saves_index';

interface SavedFile {
  id: string;
  name: string;
  content: string;
  side: 'left' | 'right';
  timestamp: string;
}

function loadAutoSave(): { left: string; right: string } | null {
  try {
    const raw = localStorage.getItem(AUTO_SAVE_KEY);
    if (raw) return JSON.parse(raw);
  } catch { /* ignore */ }
  return null;
}

function saveAutoSave(left: string, right: string) {
  try {
    localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify({ left, right, time: new Date().toISOString() }));
  } catch { /* ignore */ }
}

function loadSavesIndex(): SavedFile[] {
  try {
    const raw = localStorage.getItem(SAVES_INDEX_KEY);
    if (raw) return JSON.parse(raw);
  } catch { /* ignore */ }
  return [];
}

function persistSavesIndex(saves: SavedFile[]) {
  try {
    localStorage.setItem(SAVES_INDEX_KEY, JSON.stringify(saves));
  } catch { /* ignore */ }
}

// ---- Toast component ----
interface ToastMessage {
  id: number;
  text: string;
  type: 'success' | 'error' | 'info';
}

let toastId = 0;

function ToastContainer({ toasts, onRemove }: { toasts: ToastMessage[]; onRemove: (id: number) => void }) {
  return (
    <div style={{ position: 'fixed', top: 16, right: 16, zIndex: 9999, display: 'flex', flexDirection: 'column', gap: 8 }}>
      {toasts.map(t => (
        <div
          key={t.id}
          onClick={() => onRemove(t.id)}
          style={{
            padding: '10px 20px',
            borderRadius: 'var(--border-radius)',
            fontSize: 13,
            fontWeight: 500,
            cursor: 'pointer',
            boxShadow: 'var(--shadow-md)',
            transition: 'opacity var(--transition-speed)',
            background: t.type === 'success' ? 'var(--toast-success-bg)' : t.type === 'error' ? 'var(--toast-error-bg)' : 'var(--toast-info-bg)',
            color: t.type === 'success' ? 'var(--toast-success-text)' : t.type === 'error' ? 'var(--toast-error-text)' : 'var(--toast-info-text)',
            borderLeft: `4px solid ${t.type === 'success' ? 'var(--toast-success-border)' : t.type === 'error' ? 'var(--toast-error-border)' : 'var(--toast-info-border)'}`,
          }}
        >
          {t.text}
        </div>
      ))}
    </div>
  );
}

// ---- Modal component ----
function SaveModal({
  visible,
  onSave,
  onCancel,
}: {
  visible: boolean;
  onSave: (name: string) => void;
  onCancel: () => void;
}) {
  const [name, setName] = useState('');
  const [error, setError] = useState('');
  const inputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    if (visible) {
      setName('');
      setError('');
      setTimeout(() => inputRef.current?.focus(), 100);
    }
  }, [visible]);

  if (!visible) return null;

  const handleSave = () => {
    if (!name.trim()) {
      setError('åç§°ä¸èƒ½ä¸ºç©º');
      return;
    }
    if (!isValidSaveName(name)) {
      setError('åªèƒ½è¾“å…¥è‹±æ–‡ã€æ•°å­—å’Œä¸‹åˆ’çº¿');
      return;
    }
    onSave(name);
  };

  return (
    <div
      style={{
        position: 'fixed', inset: 0, zIndex: 10000,
        background: 'var(--bg-modal-overlay)',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
      }}
      onClick={onCancel}
    >
      <div
        style={{
          background: 'var(--bg-modal)',
          borderRadius: 'var(--border-radius)',
          padding: 24,
          minWidth: 360,
          boxShadow: 'var(--shadow-lg)',
        }}
        onClick={e => e.stopPropagation()}
      >
        <h3 style={{ marginBottom: 16, fontSize: 16, fontWeight: 600, color: 'var(--text-primary)' }}>è‡ªå®šä¹‰ä¿å­˜åç§°</h3>
        <input
          ref={inputRef}
          value={name}
          onChange={e => { setName(e.target.value); setError(''); }}
          onKeyDown={e => e.key === 'Enter' && handleSave()}
          placeholder="è¾“å…¥åç§°ï¼ˆè‹±æ–‡ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰"
          style={{
            width: '100%',
            padding: '8px 12px',
            border: `1px solid ${error ? 'var(--btn-danger-bg)' : 'var(--border-primary)'}`,
            borderRadius: 'var(--border-radius-sm)',
            fontSize: 14,
            outline: 'none',
            background: 'var(--bg-editor)',
            color: 'var(--text-primary)',
          }}
        />
        {error && <p style={{ color: 'var(--btn-danger-bg)', fontSize: 12, marginTop: 4 }}>{error}</p>}
        <div style={{ display: 'flex', gap: 8, justifyContent: 'flex-end', marginTop: 16 }}>
          <button onClick={onCancel} style={modalBtnStyle('secondary')}>å–æ¶ˆ</button>
          <button onClick={handleSave} style={modalBtnStyle('primary')}>ä¿å­˜</button>
        </div>
      </div>
    </div>
  );
}

function modalBtnStyle(variant: 'primary' | 'secondary'): React.CSSProperties {
  return {
    padding: '6px 18px',
    borderRadius: 'var(--border-radius-sm)',
    border: 'none',
    cursor: 'pointer',
    fontSize: 13,
    fontWeight: 500,
    background: variant === 'primary' ? 'var(--btn-primary-bg)' : 'var(--btn-secondary-bg)',
    color: variant === 'primary' ? 'var(--btn-primary-text)' : 'var(--btn-secondary-text)',
  };
}

// ---- Editor panel with line numbers ----
function EditorPanel({
  value,
  onChange,
  placeholder,
  diffs,
  fontSize,
  label,
  currentLine,
  onCursorChange,
}: {
  value: string;
  onChange: (v: string) => void;
  placeholder: string;
  diffs: CharDiff[] | null;
  fontSize: number;
  label: string;
  currentLine: number;
  onCursorChange: (line: number) => void;
  readOnly?: boolean;
}) {
  const textareaRef = useRef<HTMLTextAreaElement>(null);
  const highlightRef = useRef<HTMLDivElement>(null);
  const lineRef = useRef<HTMLDivElement>(null);
  const showHighlight = diffs !== null && diffs.length > 0;

  const lines = value.split('\n');
  const lineCount = lines.length || 1;

  const handleScroll = () => {
    const ta = textareaRef.current;
    if (ta && lineRef.current) {
      lineRef.current.scrollTop = ta.scrollTop;
    }
    if (ta && highlightRef.current) {
      highlightRef.current.scrollTop = ta.scrollTop;
      highlightRef.current.scrollLeft = ta.scrollLeft;
    }
  };

  const handleCursorUpdate = () => {
    if (textareaRef.current) {
      const pos = textareaRef.current.selectionStart;
      const textBefore = value.substring(0, pos);
      const line = (textBefore.match(/\n/g) || []).length + 1;
      onCursorChange(line);
    }
  };

  const handleChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    onChange(e.target.value);
  };

  const handlePaste = (e: React.ClipboardEvent<HTMLTextAreaElement>) => {
    e.preventDefault();
    const plainText = e.clipboardData.getData('text/plain');
    const ta = e.currentTarget;
    const start = ta.selectionStart;
    const end = ta.selectionEnd;
    const newValue = value.substring(0, start) + plainText + value.substring(end);
    onChange(newValue);
    // Set cursor position after paste
    requestAnimationFrame(() => {
      const newPos = start + plainText.length;
      ta.selectionStart = newPos;
      ta.selectionEnd = newPos;
    });
  };

  // Render diff-highlighted content as overlay
  const renderHighlight = () => {
    if (!diffs || diffs.length === 0) return null;
    return diffs.map((d, i) => (
      <span
        key={i}
        style={{
          color: d.type === 'same' ? 'var(--diff-same-text)' : 'var(--diff-different-text)',
        }}
      >
        {d.text}
      </span>
    ));
  };

  // Build line number width
  const lineNumWidth = Math.max(30, String(lineCount).length * 10 + 16);

  const sharedTextStyle: React.CSSProperties = {
    fontSize: fontSize,
    lineHeight: `${fontSize * 1.6}px`,
    fontFamily: "'Consolas', 'Monaco', 'Courier New', monospace",
    whiteSpace: 'pre-wrap',
    wordBreak: 'break-all',
    padding: 8,
    margin: 0,
    border: 'none',
  };

  return (
    <div style={{ display: 'flex', flexDirection: 'column', height: '100%', overflow: 'hidden' }}>
      {/* Label */}
      <div style={{
        padding: '6px 12px',
        background: 'var(--bg-tertiary)',
        color: 'var(--text-secondary)',
        fontSize: 12,
        fontWeight: 600,
        borderBottom: '1px solid var(--border-primary)',
        letterSpacing: 0.5,
      }}>
        {label}
      </div>
      <div style={{ display: 'flex', flex: 1, overflow: 'hidden' }}>
        {/* Line numbers */}
        <div
          ref={lineRef}
          style={{
            width: lineNumWidth,
            minWidth: lineNumWidth,
            background: 'var(--bg-line-number)',
            borderRight: '1px solid var(--border-primary)',
            overflowY: 'hidden',
            overflowX: 'hidden',
            userSelect: 'none',
            paddingTop: 8,
          }}
        >
          {Array.from({ length: lineCount }, (_, i) => (
            <div
              key={i}
              style={{
                height: `${fontSize * 1.6}px`,
                lineHeight: `${fontSize * 1.6}px`,
                fontSize: fontSize,
                textAlign: 'right',
                paddingRight: 8,
                color: 'var(--text-line-number)',
                background: currentLine === i + 1 ? 'var(--bg-current-line)' : 'transparent',
              }}
            >
              {i + 1}
            </div>
          ))}
        </div>
        {/* Text area container */}
        <div style={{ flex: 1, position: 'relative', overflow: 'hidden' }}>
          {/* Highlight overlay (shown when diffs exist) */}
          {showHighlight && (
            <div
              ref={highlightRef}
              style={{
                ...sharedTextStyle,
                position: 'absolute',
                top: 0,
                left: 0,
                width: '100%',
                height: '100%',
                overflow: 'auto',
                background: 'var(--bg-editor)',
                pointerEvents: 'none',
                zIndex: 1,
              }}
            >
              {renderHighlight()}
            </div>
          )}
          {/* Actual textarea for editing */}
          <textarea
            ref={textareaRef}
            value={value}
            onChange={handleChange}
            onScroll={handleScroll}
            onClick={handleCursorUpdate}
            onKeyUp={handleCursorUpdate}
            onPaste={handlePaste}
            placeholder={placeholder}
            spellCheck={false}
            style={{
              ...sharedTextStyle,
              width: '100%',
              height: '100%',
              resize: 'none',
              outline: 'none',
              background: showHighlight ? 'transparent' : 'var(--bg-editor)',
              color: showHighlight ? 'transparent' : 'var(--text-primary)',
              caretColor: 'var(--text-primary)',
              position: 'relative',
              zIndex: 2,
              overflow: 'auto',
            }}
          />
        </div>
      </div>
    </div>
  );
}

// ---- Git diff result view ----
function DiffResultView({ diffLines, fontSize }: { diffLines: UnifiedDiffLine[]; fontSize: number }) {
  if (diffLines.length === 0) {
    return (
      <div style={{
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        height: '100%', color: 'var(--text-tertiary)', fontSize: 14,
      }}>
        ç‚¹å‡»"ä¸€é”®å¯¹æ¯”"æŸ¥çœ‹å·®å¼‚ç»“æœ
      </div>
    );
  }

  return (
    <div style={{
      height: '100%', overflowY: 'auto', padding: 12,
      background: 'var(--bg-editor)',
      fontFamily: "'Consolas', 'Monaco', 'Courier New', monospace",
      fontSize: fontSize,
      lineHeight: `${fontSize * 1.6}px`,
    }}>
      {/* Title */}
      <div style={{
        color: 'var(--diff-header-text)',
        fontWeight: 700,
        fontSize: fontSize + 2,
        marginBottom: 4,
      }}>
        Gité£æ ¼å¯¹æ¯”ç»“æœï¼š
      </div>
      <div style={{
        color: 'var(--diff-separator)',
        fontWeight: 700,
        marginBottom: 8,
      }}>
        {'='.repeat(60)}
      </div>

      {diffLines.map((line, i) => {
        let bg = 'transparent';
        let color = 'var(--diff-context-text)';
        let fontWeight: number | string = 'normal';

        switch (line.type) {
          case 'file-old':
          case 'file-new':
            color = 'var(--diff-header-text)';
            fontWeight = 700;
            break;
          case 'hunk':
            color = 'var(--diff-separator)';
            fontWeight = 600;
            break;
          case 'add':
            bg = 'var(--diff-added-bg)';
            color = 'var(--diff-added-text)';
            break;
          case 'delete':
            bg = 'var(--diff-deleted-bg)';
            color = 'var(--diff-deleted-text)';
            break;
          case 'context':
            color = 'var(--diff-context-text)';
            break;
        }

        const displayContent = line.type === 'hunk' && line.simplified
          ? line.simplified
          : line.content;

        return (
          <div
            key={i}
            style={{
              background: bg,
              color: color,
              fontWeight: fontWeight,
              padding: '1px 6px',
              borderRadius: 2,
              whiteSpace: 'pre-wrap',
              wordBreak: 'break-all',
            }}
          >
            {displayContent}
          </div>
        );
      })}
    </div>
  );
}

// ---- Splitter ----
function Splitter({ onDrag }: { onDrag: (dx: number) => void }) {
  const dragging = useRef(false);
  const lastX = useRef(0);

  const handleMouseDown = (e: React.MouseEvent) => {
    e.preventDefault();
    dragging.current = true;
    lastX.current = e.clientX;

    const handleMouseMove = (ev: MouseEvent) => {
      if (!dragging.current) return;
      const dx = ev.clientX - lastX.current;
      lastX.current = ev.clientX;
      onDrag(dx);
    };

    const handleMouseUp = () => {
      dragging.current = false;
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    };

    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
  };

  return (
    <div
      onMouseDown={handleMouseDown}
      style={{
        width: 6,
        minWidth: 6,
        cursor: 'col-resize',
        background: 'var(--bg-splitter)',
        transition: 'background var(--transition-speed)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
      }}
      onMouseEnter={e => (e.currentTarget.style.background = 'var(--bg-splitter-hover)')}
      onMouseLeave={e => (e.currentTarget.style.background = 'var(--bg-splitter)')}
    >
      <div style={{
        width: 2,
        height: 30,
        borderRadius: 1,
        background: 'var(--text-tertiary)',
        opacity: 0.5,
      }} />
    </div>
  );
}

// ---- Saved file list item ----
function SavedItem({
  file,
  onClick,
  onDelete,
}: {
  file: SavedFile;
  onClick: () => void;
  onDelete: () => void;
}) {
  return (
    <div
      style={{
        display: 'inline-flex',
        alignItems: 'center',
        gap: 4,
        padding: '4px 10px',
        background: 'var(--bg-saved-item)',
        borderRadius: 'var(--border-radius-sm)',
        fontSize: 12,
        whiteSpace: 'nowrap',
        cursor: 'pointer',
        border: '1px solid var(--border-primary)',
        transition: 'background var(--transition-speed)',
      }}
      onClick={onClick}
      onMouseEnter={e => (e.currentTarget.style.background = 'var(--bg-saved-item-hover)')}
      onMouseLeave={e => (e.currentTarget.style.background = 'var(--bg-saved-item)')}
    >
      <span style={{ color: 'var(--text-primary)', maxWidth: 120, overflow: 'hidden', textOverflow: 'ellipsis' }}>
        {file.name}
      </span>
      <span
        onClick={e => { e.stopPropagation(); onDelete(); }}
        style={{
          marginLeft: 4,
          color: 'var(--btn-danger-bg)',
          fontWeight: 700,
          fontSize: 14,
          lineHeight: '14px',
          cursor: 'pointer',
          padding: '0 2px',
        }}
        title="åˆ é™¤"
      >
        Ã—
      </span>
    </div>
  );
}

// ---- Button helper ----
function ToolButton({
  children,
  onClick,
  variant = 'secondary',
  disabled = false,
  title,
  small = false,
}: {
  children: React.ReactNode;
  onClick: () => void;
  variant?: 'primary' | 'secondary' | 'danger' | 'success' | 'warning';
  disabled?: boolean;
  title?: string;
  small?: boolean;
}) {
  const bgMap: Record<string, string> = {
    primary: 'var(--btn-primary-bg)',
    secondary: 'var(--btn-secondary-bg)',
    danger: 'var(--btn-danger-bg)',
    success: 'var(--btn-success-bg)',
    warning: 'var(--btn-warning-bg)',
  };
  const hoverMap: Record<string, string> = {
    primary: 'var(--btn-primary-hover)',
    secondary: 'var(--btn-secondary-hover)',
    danger: 'var(--btn-danger-hover)',
    success: 'var(--btn-success-hover)',
    warning: 'var(--btn-warning-hover)',
  };
  const colorMap: Record<string, string> = {
    primary: 'var(--btn-primary-text)',
    secondary: 'var(--btn-secondary-text)',
    danger: 'var(--btn-danger-text)',
    success: 'var(--btn-success-text)',
    warning: 'var(--btn-warning-text)',
  };

  const [hovered, setHovered] = useState(false);

  return (
    <button
      onClick={disabled ? undefined : onClick}
      disabled={disabled}
      title={title}
      onMouseEnter={() => setHovered(true)}
      onMouseLeave={() => setHovered(false)}
      style={{
        padding: small ? '3px 8px' : '5px 14px',
        borderRadius: 'var(--border-radius-sm)',
        border: 'none',
        cursor: disabled ? 'not-allowed' : 'pointer',
        fontSize: small ? 11 : 12,
        fontWeight: 500,
        background: disabled ? 'var(--btn-disabled-bg)' : (hovered ? hoverMap[variant] : bgMap[variant]),
        color: disabled ? 'var(--btn-disabled-text)' : colorMap[variant],
        transition: 'background var(--transition-speed)',
        whiteSpace: 'nowrap',
      }}
    >
      {children}
    </button>
  );
}

// ===================== MAIN COMPONENT =====================
export default function ComparePage() {
  // ---- State ----
  const [leftText, setLeftText] = useState('');
  const [rightText, setRightText] = useState('');
  const [leftDiffs, setLeftDiffs] = useState<CharDiff[] | null>(null);
  const [rightDiffs, setRightDiffs] = useState<CharDiff[] | null>(null);
  const [diffLines, setDiffLines] = useState<UnifiedDiffLine[]>([]);
  const [viewMode, setViewMode] = useState<'editor' | 'diff'>('editor');
  const [diffReady, setDiffReady] = useState(false);
  const [fontSize, setFontSize] = useState(13);
  const [autoSaveEnabled, setAutoSaveEnabled] = useState(true);
  const [savedFiles, setSavedFiles] = useState<SavedFile[]>([]);
  const [toasts, setToasts] = useState<ToastMessage[]>([]);
  const [modalVisible, setModalVisible] = useState(false);
  const [modalSide, setModalSide] = useState<'left' | 'right'>('left');
  const [leftCursorLine, setLeftCursorLine] = useState(1);
  const [rightCursorLine, setRightCursorLine] = useState(1);
  const [leftWidth, setLeftWidth] = useState(50); // percentage
  const [theme, setTheme] = useState<'light' | 'dark'>('light');

  // ---- Toast helpers ----
  const addToast = useCallback((text: string, type: ToastMessage['type'] = 'info', duration = 3000) => {
    const id = ++toastId;
    setToasts(prev => [...prev, { id, text, type }]);
    setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), duration);
  }, []);

  const removeToast = useCallback((id: number) => {
    setToasts(prev => prev.filter(t => t.id !== id));
  }, []);

  // ---- Theme toggle ----
  useEffect(() => {
    document.documentElement.setAttribute('data-theme', theme);
  }, [theme]);

  // ---- Auto load on mount ----
  useEffect(() => {
    // Load auto save
    const saved = loadAutoSave();
    if (saved) {
      setLeftText(saved.left);
      setRightText(saved.right);
      addToast('å·²è‡ªåŠ¨åŠ è½½ä¸Šæ¬¡ä¿å­˜çš„å†…å®¹', 'info');
    }
    // Load saved files list
    const files = loadSavesIndex();
    setSavedFiles(files);
  }, []); // eslint-disable-line react-hooks/exhaustive-deps

  // ---- Auto save timer ----
  useEffect(() => {
    if (!autoSaveEnabled) return;
    const interval = setInterval(() => {
      saveAutoSave(leftText, rightText);
      addToast('è‡ªåŠ¨ä¿å­˜æˆåŠŸ', 'success', 2000);
    }, 60000);
    return () => clearInterval(interval);
  }, [autoSaveEnabled, leftText, rightText, addToast]);

  // ---- Compare ----
  const handleCompare = useCallback(() => {
    if (!leftText.trim() && !rightText.trim()) {
      addToast('è¯·è¾“å…¥æ–‡æœ¬åå†è¿›è¡Œå¯¹æ¯”', 'error');
      return;
    }

    // Character-level diff
    const { leftDiffs: ld, rightDiffs: rd } = getCharDiffs(leftText, rightText);
    setLeftDiffs(ld);
    setRightDiffs(rd);

    // Git-style diff
    const unified = generateUnifiedDiff(leftText, rightText);
    setDiffLines(unified);

    setDiffReady(true);
    setViewMode('diff');
    addToast('å¯¹æ¯”å®Œæˆ', 'success');
  }, [leftText, rightText, addToast]);

  // ---- Clear ----
  const handleClear = useCallback(() => {
    setLeftText('');
    setRightText('');
    setLeftDiffs(null);
    setRightDiffs(null);
    setDiffLines([]);
    setDiffReady(false);
    setViewMode('editor');
    setLeftWidth(50);
    addToast('å·²æ¸…ç©ºæ‰€æœ‰å†…å®¹', 'info');
  }, [addToast]);

  // ---- Clear styles only ----
  const handleClearStyles = useCallback(() => {
    setLeftDiffs(null);
    setRightDiffs(null);
    addToast('æ ·å¼å·²æ¸…ç©º', 'info');
  }, [addToast]);

  // ---- Save helpers ----
  const doSave = useCallback((side: 'left' | 'right', customName?: string) => {
    const content = side === 'left' ? leftText : rightText;
    if (!content.trim()) {
      addToast(`${side === 'left' ? 'å·¦ä¾§' : 'å³ä¾§'}å†…å®¹ä¸ºç©ºï¼Œæ— æ³•ä¿å­˜`, 'error');
      return;
    }

    const fromContent = extractFromContent(content);
    const defaultName = fromContent || (side === 'left' ? 'å·¦ä¾§å†…å®¹' : 'å³ä¾§å†…å®¹');
    const name = customName || `${defaultName}_${getTimestamp()}`;

    const file: SavedFile = {
      id: `compare_${getTimestamp()}_${Math.random().toString(36).slice(2, 6)}`,
      name,
      content,
      side,
      timestamp: new Date().toISOString(),
    };

    const newSaves = [...savedFiles, file];
    setSavedFiles(newSaves);
    persistSavesIndex(newSaves);
    addToast(`ä¿å­˜æˆåŠŸï¼š${name}`, 'success');
  }, [leftText, rightText, savedFiles, addToast]);

  const handleSaveLeft = useCallback(() => doSave('left'), [doSave]);
  const handleSaveRight = useCallback(() => doSave('right'), [doSave]);

  const handleCustomSave = useCallback((side: 'left' | 'right') => {
    setModalSide(side);
    setModalVisible(true);
  }, []);

  const handleModalSave = useCallback((name: string) => {
    doSave(modalSide, name);
    setModalVisible(false);
  }, [doSave, modalSide]);

  // ---- Load saved file ----
  const handleLoadFile = useCallback((file: SavedFile) => {
    setRightText(file.content);
    addToast(`å·²åŠ è½½ï¼š${file.name}`, 'success');
  }, [addToast]);

  // ---- Delete saved file ----
  const handleDeleteFile = useCallback((id: string) => {
    const newSaves = savedFiles.filter(f => f.id !== id);
    setSavedFiles(newSaves);
    persistSavesIndex(newSaves);
    addToast('åˆ é™¤æˆåŠŸ', 'success');
  }, [savedFiles, addToast]);

  // ---- Export result ----
  const handleExportResult = useCallback(() => {
    if (diffLines.length === 0) {
      addToast('æ²¡æœ‰å¯¹æ¯”ç»“æœå¯å¯¼å‡º', 'error');
      return;
    }

    let md = '# æ–‡æœ¬å¯¹æ¯”ç»“æœ\n\n';
    md += `> å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString()}\n\n`;
    md += '```diff\n';
    for (const line of diffLines) {
      const content = line.type === 'hunk' && line.simplified ? line.simplified : line.content;
      md += content + '\n';
    }
    md += '```\n';

    const blob = new Blob([md], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `diff_result_${getTimestamp()}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    addToast('å¯¼å‡ºæˆåŠŸ', 'success');
  }, [diffLines, addToast]);

  // ---- Font size ----
  const handleFontIncrease = useCallback(() => {
    setFontSize(prev => Math.min(prev + 2, 18));
  }, []);
  const handleFontDecrease = useCallback(() => {
    setFontSize(prev => Math.max(prev - 2, 6));
  }, []);
  const handleFontReset = useCallback(() => {
    setFontSize(13);
  }, []);

  // ---- Splitter drag ----
  const containerRef = useRef<HTMLDivElement>(null);
  const handleSplitterDrag = useCallback((dx: number) => {
    if (!containerRef.current) return;
    const totalWidth = containerRef.current.offsetWidth;
    const pctChange = (dx / totalWidth) * 100;
    setLeftWidth(prev => Math.max(20, Math.min(80, prev + pctChange)));
  }, []);

  // ---- View toggle ----
  const handleToggleView = useCallback(() => {
    setViewMode(prev => prev === 'editor' ? 'diff' : 'editor');
  }, []);

  // ---- Manual save to auto save ----
  const handleManualAutoSave = useCallback(() => {
    saveAutoSave(leftText, rightText);
    addToast('æ‰‹åŠ¨ä¿å­˜æˆåŠŸ', 'success');
  }, [leftText, rightText, addToast]);

  return (
    <div style={{
      width: '100%',
      height: '100vh',
      display: 'flex',
      flexDirection: 'column',
      background: 'var(--bg-primary)',
      overflow: 'hidden',
    }}>
      {/* Toasts */}
      <ToastContainer toasts={toasts} onRemove={removeToast} />

      {/* Save Modal */}
      <SaveModal
        visible={modalVisible}
        onSave={handleModalSave}
        onCancel={() => setModalVisible(false)}
      />

      {/* ======= Header / Toolbar ======= */}
      <div style={{
        background: 'var(--bg-secondary)',
        borderBottom: '1px solid var(--border-primary)',
        padding: '0 12px',
      }}>
        {/* Top row: title + theme */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          height: 'var(--header-height)',
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
            <span style={{ fontSize: 18, fontWeight: 700, color: 'var(--text-primary)' }}>ğŸ“ æ–‡æœ¬å¯¹æ¯”å·¥å…·</span>
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
            {/* Auto save toggle */}
            <label style={{
              display: 'flex', alignItems: 'center', gap: 4, fontSize: 12,
              color: 'var(--text-secondary)', cursor: 'pointer',
            }}>
              <input
                type="checkbox"
                checked={autoSaveEnabled}
                onChange={e => setAutoSaveEnabled(e.target.checked)}
              />
              è‡ªåŠ¨ä¿å­˜
            </label>
            {/* Theme toggle */}
            <ToolButton
              onClick={() => setTheme(prev => prev === 'light' ? 'dark' : 'light')}
              small
            >
              {theme === 'light' ? 'ğŸŒ™ æš—è‰²' : 'â˜€ï¸ äº®è‰²'}
            </ToolButton>
          </div>
        </div>

        {/* Toolbar row */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          gap: 6,
          height: 'var(--toolbar-height)',
          flexWrap: 'wrap',
          paddingBottom: 6,
        }}>
          {/* Compare */}
          <ToolButton onClick={handleCompare} variant="primary">âš¡ ä¸€é”®å¯¹æ¯”</ToolButton>

          {/* View toggle */}
          <ToolButton
            onClick={handleToggleView}
            disabled={!diffReady}
            variant="secondary"
          >
            {viewMode === 'editor' ? 'ğŸ“Š æŸ¥çœ‹ç»“æœ' : 'ğŸ“ æŸ¥çœ‹åŸæ–‡'}
          </ToolButton>

          <div style={{ width: 1, height: 20, background: 'var(--border-primary)', margin: '0 2px' }} />

          {/* Save buttons */}
          <ToolButton onClick={handleSaveLeft} variant="success">ğŸ’¾ ä¿å­˜å·¦ä¾§</ToolButton>
          <ToolButton onClick={handleSaveRight} variant="success">ğŸ’¾ ä¿å­˜å³ä¾§</ToolButton>
          <ToolButton onClick={() => handleCustomSave('left')} variant="secondary" title="è‡ªå®šä¹‰åç§°ä¿å­˜å·¦ä¾§">ğŸ“‹ è‡ªå®šä¹‰ä¿å­˜å·¦</ToolButton>
          <ToolButton onClick={() => handleCustomSave('right')} variant="secondary" title="è‡ªå®šä¹‰åç§°ä¿å­˜å³ä¾§">ğŸ“‹ è‡ªå®šä¹‰ä¿å­˜å³</ToolButton>
          <ToolButton onClick={handleManualAutoSave} variant="secondary">ğŸ’¾ æ‰‹åŠ¨ä¿å­˜</ToolButton>

          <div style={{ width: 1, height: 20, background: 'var(--border-primary)', margin: '0 2px' }} />

          {/* Export */}
          <ToolButton onClick={handleExportResult} variant="warning" disabled={!diffReady}>ğŸ“¤ å¯¼å‡ºç»“æœ</ToolButton>

          <div style={{ width: 1, height: 20, background: 'var(--border-primary)', margin: '0 2px' }} />

          {/* Clear */}
          <ToolButton onClick={handleClear} variant="danger">ğŸ—‘ï¸ æ¸…ç©ºå†…å®¹</ToolButton>
          <ToolButton onClick={handleClearStyles} variant="secondary">ğŸ§¹ æ¸…ç©ºæ ·å¼</ToolButton>

          <div style={{ width: 1, height: 20, background: 'var(--border-primary)', margin: '0 2px' }} />

          {/* Font size */}
          <ToolButton onClick={handleFontDecrease} small>A-</ToolButton>
          <span style={{ fontSize: 11, color: 'var(--text-secondary)', minWidth: 28, textAlign: 'center' }}>{fontSize}px</span>
          <ToolButton onClick={handleFontIncrease} small>A+</ToolButton>
          <ToolButton onClick={handleFontReset} small>é‡ç½®</ToolButton>
        </div>
      </div>

      {/* ======= Saved files bar ======= */}
      {savedFiles.length > 0 && (
        <div style={{
          display: 'flex',
          alignItems: 'center',
          gap: 6,
          padding: '4px 12px',
          background: 'var(--bg-tertiary)',
          borderBottom: '1px solid var(--border-primary)',
          overflowX: 'auto',
          overflowY: 'hidden',
          minHeight: 'var(--saved-list-height)',
        }}>
          <span style={{ fontSize: 11, color: 'var(--text-tertiary)', whiteSpace: 'nowrap', marginRight: 4 }}>
            å·²ä¿å­˜:
          </span>
          {savedFiles.map(f => (
            <SavedItem
              key={f.id}
              file={f}
              onClick={() => handleLoadFile(f)}
              onDelete={() => handleDeleteFile(f.id)}
            />
          ))}
        </div>
      )}

      {/* ======= Main content area ======= */}
      <div
        ref={containerRef}
        style={{
          flex: 1,
          display: 'flex',
          overflow: 'hidden',
          position: 'relative',
        }}
      >
        {viewMode === 'editor' ? (
          <>
            {/* Left editor */}
            <div style={{
              width: `${leftWidth}%`,
              minWidth: '20%',
              maxWidth: '80%',
              overflow: 'hidden',
              borderRight: 'none',
              display: 'flex',
              flexDirection: 'column',
            }}>
              <EditorPanel
                value={leftText}
                onChange={setLeftText}
                placeholder="åœ¨æ­¤è¾“å…¥åŸå§‹æ–‡æœ¬..."
                diffs={leftDiffs}
                fontSize={fontSize}
                label="åŸå§‹æ–‡æœ¬ (å·¦ä¾§)"
                currentLine={leftCursorLine}
                onCursorChange={setLeftCursorLine}
              />
            </div>

            {/* Splitter */}
            <Splitter onDrag={handleSplitterDrag} />

            {/* Right editor */}
            <div style={{
              flex: 1,
              overflow: 'hidden',
              display: 'flex',
              flexDirection: 'column',
            }}>
              <EditorPanel
                value={rightText}
                onChange={setRightText}
                placeholder="åœ¨æ­¤è¾“å…¥ä¿®æ”¹åæ–‡æœ¬..."
                diffs={rightDiffs}
                fontSize={fontSize}
                label="ä¿®æ”¹åæ–‡æœ¬ (å³ä¾§)"
                currentLine={rightCursorLine}
                onCursorChange={setRightCursorLine}
              />
            </div>
          </>
        ) : (
          /* Diff result view */
          <div style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
            <DiffResultView diffLines={diffLines} fontSize={fontSize} />
          </div>
        )}
      </div>

      {/* ======= Status bar ======= */}
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        padding: '4px 12px',
        background: 'var(--bg-secondary)',
        borderTop: '1px solid var(--border-primary)',
        fontSize: 11,
        color: 'var(--text-tertiary)',
      }}>
        <div style={{ display: 'flex', gap: 16 }}>
          <span>å·¦ä¾§: {leftText.split('\n').length} è¡Œ, {leftText.length} å­—ç¬¦</span>
          <span>å³ä¾§: {rightText.split('\n').length} è¡Œ, {rightText.length} å­—ç¬¦</span>
        </div>
        <div style={{ display: 'flex', gap: 16 }}>
          <span>å…‰æ ‡è¡Œ: L{leftCursorLine} / R{rightCursorLine}</span>
          <span>å­—ä½“: {fontSize}px</span>
          <span>è‡ªåŠ¨ä¿å­˜: {autoSaveEnabled ? 'å¼€å¯' : 'å…³é—­'}</span>
        </div>
      </div>
    </div>
  );
}
